// Prisma schema for Supersender MVP

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  CLIENT
  WAREHOUSE
  ADMIN
  SUPERADMIN
}

enum DeliveryExpectedStatus {
  EXPECTED
  RECEIVED
  REJECTED
}

enum WarehouseOrderStatus {
  AT_WAREHOUSE
  BEING_PACKED
  TO_PACK
  READY_FOR_QUOTE
  READY_TO_SHIP
  SHIPPED
  DELIVERED
}

enum ShipmentStatus {
  REQUESTED
  QUOTED
  AWAITING_ACCEPTANCE
  AWAITING_PAYMENT
  READY_FOR_LOADING
  IN_TRANSIT
  DELIVERED
}

enum InvoiceType {
  SUBSCRIPTION
  TRANSPORT
  OPERATIONS
}

enum InvoiceStatus {
  ISSUED
  PAID
  OVERDUE
}

enum TransportMode {
  MAK
  CLIENT_OWN
}

enum PackageType {
  PACKAGE
  PALLET
}

enum TransportPricingType {
  FIXED_PER_UNIT
  DYNAMIC_M3_WEIGHT
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  phone        String?
  role         Role     @default(CLIENT)
  client       Client?  @relation(fields: [clientId], references: [id])
  clientId     String?
  changeLogs   ChangeLog[]
  salesClients Client[] @relation("SalesOwner")
  quotedShipments ShipmentOrder[]
  settings     UserSettings?
  createdVouchers Voucher[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model UserSettings {
  id                String   @id @default(cuid())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String   @unique
  deliveryReceived  Boolean  @default(true)
  shipmentReady     Boolean  @default(true)
  invoiceIssued     Boolean  @default(true)
  paymentReminder   Boolean  @default(true)
  overStorageAlert  Boolean  @default(true)
  newsletter        Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Client {
  id                         String    @id @default(cuid())
  displayName                String
  email                      String
  phone                      String?
  country                    String
  clientCode                 String    @unique
  salesOwnerCode             String
  plan                       Plan?     @relation(fields: [planId], references: [id])
  planId                     String?
  status                     String
  spaceUsagePct              Int       @default(0)
  usedCbm                    Float     @default(0)
  limitCbm                   Float     @default(0)
  caretakerName              String?
  caretakerContact           String?
  salesOwner                 User?     @relation("SalesOwner", fields: [salesOwnerId], references: [id])
  salesOwnerId               String?
  subscriptionDiscount       Float?    // Max 30% for admin, unlimited for superadmin
  additionalServicesDiscount Float?    // Max 40% for admin, unlimited for superadmin
  revolutCustomerId         String?   // For Revolut Pay customer reuse
  invoiceName                String?   // Name for invoice purposes
  businessName               String?   // Business/company name (optional)
  vatNumber                  String?   // EU VAT Number (optional)
  invoiceAddress             String?   // Full invoice address (backward compatibility)
  invoiceAddressLine1        String?   // Invoice address line 1
  invoiceAddressLine2        String?   // Invoice address line 2
  invoiceCity                String?   // Invoice city
  invoicePostCode            String?   // Invoice postal code
  // Individual plan custom conditions
  individualCbm                      Float?    // Custom CBM limit for Individual plan
  individualDeliveriesPerMonth      Int?      // Custom deliveries per month for Individual plan
  individualShipmentsPerMonth       Int?      // Custom shipments per month for Individual plan
  individualOperationsRateEur       Float?    // Custom operations rate in EUR for Individual plan
  individualOverSpaceRateEur        Float?    // Custom over-space rate in EUR for Individual plan
  individualAdditionalServicesRateEur Float? // Custom additional services rate in EUR for Individual plan
  // Subscription dates
  subscriptionStartDate             DateTime? // When subscription starts
  subscriptionEndDate                DateTime? // When subscription expires

  users              User[]
  addresses          Address[]
  expectedDeliveries DeliveryExpected[]
  warehouseOrders    WarehouseOrder[]
  shipmentOrders     ShipmentOrder[]
  invoices           Invoice[]
  warehouseCapacity  WarehouseCapacity?
  usedVouchers        Voucher[]
  monthlyCharges     MonthlyAdditionalCharges[]
  proformas          ProformaInvoice[]

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model Plan {
  id                 String   @id @default(cuid())
  name               String
  deliveriesPerMonth Int
  spaceLimitCbm      Float
  overSpaceRateEur   Float
  operationsRateEur  Float
  clients            Client[]
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model DeliveryExpected {
  id               String                  @id @default(cuid())
  client           Client                  @relation(fields: [clientId], references: [id])
  clientId         String
  deliveryNumber   String?                 @unique // Auto-generated unique number (e.g., "DEL-2024-001")
  supplierName     String
  goodsDescription String
  orderNumber      String?
  eta              DateTime?
  status           DeliveryExpectedStatus  @default(EXPECTED)
  location         String?
  photos           Media[]
  warehouseOrder   WarehouseOrder?
  createdAt        DateTime                @default(now())
}

model WarehouseOrder {
  id                 String                 @id @default(cuid())
  client             Client                 @relation(fields: [clientId], references: [id])
  clientId           String
  sourceDelivery     DeliveryExpected?      @relation(fields: [sourceDeliveryId], references: [id])
  sourceDeliveryId   String?                @unique
  status             WarehouseOrderStatus   @default(AT_WAREHOUSE)
  packedLengthCm     Int?
  packedWidthCm      Int?
  packedHeightCm     Int?
  packedWeightKg     Float?
  photosBeforeWrap   Media[] @relation("PhotosBeforeWrap")
  photosAfterWrap    Media[] @relation("PhotosAfterWrap")
  packages           Package[]
  createdAt          DateTime               @default(now())
  shipmentItems      ShipmentItem[]
}

model ShipmentOrder {
  id                 String           @id @default(cuid())
  client             Client           @relation(fields: [clientId], references: [id])
  clientId           String
  deliveryAddress    Address          @relation(fields: [deliveryAddressId], references: [id])
  deliveryAddressId  String
  transportMode        TransportMode
  timeWindowFrom     DateTime?
  timeWindowTo       DateTime?
  status             ShipmentStatus   @default(REQUESTED)
  proposedPriceEur   Float?
  calculatedPriceEur Float?
  transportPricing   TransportPricing? @relation(fields: [transportPricingId], references: [id])
  transportPricingId String?
  clientTransportChoice String?      // 'ACCEPT', 'REQUEST_CUSTOM', 'OWN_TRANSPORT'
  customQuoteRequestedAt DateTime?
  salesOwner         User?           @relation(fields: [salesOwnerId], references: [id])
  salesOwnerId       String?
  acceptedAt         DateTime?
  // Own transport details
  ownTransportVehicleReg String?     // Vehicle registration number (for pallets/lorry)
  ownTransportTrailerReg String?     // Trailer registration number (optional, for pallets/lorry)
  ownTransportCarrier   String?     // Carrier name (for parcels)
  ownTransportTrackingNumber String? // Tracking number (for parcels)
  ownTransportPlannedLoadingDate DateTime? // Planned loading date (set by client)
  // MAK transport details (set by warehouse/admin)
  transportCompanyName String?      // Transport company name
  plannedLoadingDate DateTime?      // Planned loading date (set by warehouse/admin)
  plannedDeliveryDateFrom DateTime?  // Planned delivery date range (from)
  plannedDeliveryDateTo DateTime?   // Planned delivery date range (to)
  items              ShipmentItem[]
  packages           Package[]        // Packages created when packing this shipment
  createdAt          DateTime         @default(now())
}

model ShipmentItem {
  id               String          @id @default(cuid())
  shipment         ShipmentOrder   @relation(fields: [shipmentId], references: [id])
  shipmentId       String
  warehouseOrder   WarehouseOrder  @relation(fields: [warehouseOrderId], references: [id])
  warehouseOrderId String
  @@unique([shipmentId, warehouseOrderId])
}

model Invoice {
  id                String        @id @default(cuid())
  client            Client        @relation(fields: [clientId], references: [id])
  clientId          String
  type              InvoiceType
  amountEur         Float
  currency          String        @default("EUR")
  status            InvoiceStatus @default(ISSUED)
  invoiceNumber     String?       // Invoice number from external invoicing system (editable by admin/superadmin)
  // Subscription metadata (for SUBSCRIPTION invoices)
  subscriptionStartDate DateTime? // When subscription should start
  subscriptionPeriod    String?  // Subscription period in months ('1', '3', '6')
  subscriptionPlanId    String?  // Plan ID for subscription invoice
  revolutLink       String?
  revolutOrderId    String?       // Revolut order ID
  revolutPublicId   String?       // Revolut public order ID
  revolutCheckoutUrl String?      // Revolut checkout URL
  revolutState      String?       // PENDING, COMPLETED, DECLINED, CANCELLED
  providerCustomerId String?      // For payment provider customer reuse
  revolutPaymentId  String?       // Revolut payment ID (for webhook matching)
  dueDate           DateTime
  createdAt         DateTime      @default(now())
  paidAt            DateTime?
}

model Address {
  id            String   @id @default(cuid())
  client        Client   @relation(fields: [clientId], references: [id])
  clientId      String
  contactName   String
  contactPhone  String
  line1         String
  line2         String?
  city          String
  postalCode    String
  country       String
  isDefault     Boolean  @default(false)
  shipments     ShipmentOrder[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Media {
  id                    String           @id @default(cuid())
  url                   String
  kind                  String
  deliveryExpected      DeliveryExpected? @relation(fields: [deliveryExpectedId], references: [id])
  deliveryExpectedId    String?
  warehouseOrderBefore  WarehouseOrder?   @relation("PhotosBeforeWrap", fields: [warehouseOrderBeforeId], references: [id])
  warehouseOrderBeforeId String?
  warehouseOrderAfter   WarehouseOrder?   @relation("PhotosAfterWrap", fields: [warehouseOrderAfterId], references: [id])
  warehouseOrderAfterId  String?
  createdAt             DateTime          @default(now())
}

model ChangeLog {
  id         String   @id @default(cuid())
  actor      User     @relation(fields: [actorId], references: [id])
  actorId    String
  entityType String
  entityId   String
  action     String
  details    String?
  createdAt  DateTime @default(now())
}

model Package {
  id              String          @id @default(cuid())
  warehouseOrder  WarehouseOrder?  @relation(fields: [warehouseOrderId], references: [id], onDelete: Cascade)
  warehouseOrderId String?
  shipmentOrder   ShipmentOrder?   @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  shipmentId      String?
  type            PackageType     @default(PACKAGE)
  widthCm         Int
  lengthCm        Int
  heightCm        Int
  weightKg        Float
  volumeCbm       Float           // Calculated: (width * length * height) / 1,000,000 * 1.05
  createdAt       DateTime        @default(now())
}

model WarehouseCapacity {
  id              String   @id @default(cuid())
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId        String   @unique
  limitCbm       Float      @default(0)
  usedCbm        Float     @default(0)
  usagePercent    Float     @default(0)
  isOverLimit     Boolean   @default(false)
  lastCalculatedAt DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model TransportPricing {
  id              String   @id @default(cuid())
  name            String
  type            TransportPricingType @default(FIXED_PER_UNIT)
  weightMinKg     Float?
  weightMaxKg     Float?
  volumeMinCbm    Float?
  volumeMaxCbm    Float?
  palletCountMin  Int?     // For pallet pricing rules
  palletCountMax  Int?     // For pallet pricing rules
  priceEur        Float
  transportType   String   @default("PALLET") // 'PALLET' or 'PACKAGE'
  isActive        Boolean  @default(true)
  priority        Int      @default(0) // Higher priority = checked first
  shipments       ShipmentOrder[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model MetricsDaily {
  id                    String   @id @default(cuid())
  date                  DateTime @unique @db.Date
  totalCbmUsed          Float    @default(0)
  totalClients          Int      @default(0)
  averageUsagePercent   Float    @default(0)
  totalRevenueEur       Float    @default(0)
  subscriptionRevenueEur Float   @default(0)
  transportRevenueEur   Float    @default(0)
  overSpaceRevenueEur   Float    @default(0)
  averageTransportCostEur Float?
  totalShipments        Int      @default(0)
  clientsOverLimit      Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model TranslationCache {
  id            String   @id @default(cuid())
  originalText  String
  translatedText String
  sourceLang    String
  targetLang    String
  createdAt     DateTime @default(now())

  @@unique([originalText, sourceLang, targetLang])
}

model SetupFee {
  id                String   @id @default(cuid())
  suggestedAmountEur Float    @default(119.0) // Suggested setup fee (â‚¬119)
  currentAmountEur   Float    @default(119.0) // Current promotional amount
  validUntil         DateTime? // Date until which current amount is valid (null = no expiration)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Voucher {
  id            String   @id @default(cuid())
  code          String   @unique // Voucher code (e.g., "BOOK20")
  amountEur     Float    // Discount amount in EUR
  isOneTime     Boolean  @default(true) // Can only be used once
  usedBy        Client?  @relation(fields: [usedByClientId], references: [id])
  usedByClientId String? // Client who used this voucher (null if unused)
  usedAt        DateTime? // When voucher was used
  createdBy     User     @relation(fields: [createdById], references: [id])
  createdById   String
  expiresAt     DateTime? // Optional expiration date
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model PageVisit {
  id              String   @id @default(cuid())
  sessionId       String   // Unique session identifier (fingerprint)
  pagePath        String   // e.g., "/landing/en", "/landing/pl/transport-costs"
  language        String?  // Language code (en, pl, de, fr, it)
  country         String?  // Country code from IP geolocation
  countryName     String?  // Full country name
  city            String?  // City name
  region          String?  // Region/state
  ipAddress       String?  // IP address (hashed for privacy)
  userAgent       String?  // Browser user agent
  referrer        String?  // Referrer URL
  timeOnPage      Int?     // Time spent on page in seconds
  scrollDepth     Float?   // Scroll depth percentage (0-100)
  viewportWidth   Int?     // Viewport width
  viewportHeight  Int?     // Viewport height
  deviceType      String?  // mobile, tablet, desktop
  browser         String?  // Browser name
  os              String?  // Operating system
  isUnique        Boolean  @default(true) // First visit in session
  visitedSections String[] // Array of section IDs that were viewed
  createdAt       DateTime @default(now())
  
  @@index([country])
  @@index([createdAt])
  @@index([sessionId])
  @@index([pagePath])
}

model MonthlyAdditionalCharges {
  id                String   @id @default(cuid())
  client            Client   @relation(fields: [clientId], references: [id])
  clientId         String
  month            Int      // Month (1-12)
  year             Int      // Year (e.g., 2024)
  overSpaceAmountEur Float   @default(0) // Charges for exceeding space limit
  additionalServicesAmountEur Float @default(0) // Charges for additional services
  totalAmountEur    Float   // Total additional charges for the month
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([clientId, month, year])
  @@index([clientId])
  @@index([year, month])
}

model ProformaInvoice {
  id                String   @id @default(cuid())
  client            Client   @relation(fields: [clientId], references: [id])
  clientId         String
  month            Int      // Month (1-12)
  year             Int      // Year (e.g., 2024)
  amountEur        Float    // Total amount from MonthlyAdditionalCharges
  status           String   @default("PENDING") // PENDING, PAID, OVERDUE
  dueDate          DateTime // 7 days from month end
  paymentLink      String?  // Payment link if available
  revolutOrderId   String?  // Revolut order ID if paid via Revolut
  revolutCheckoutUrl String? // Revolut checkout URL
  paidAt           DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([clientId, month, year])
  @@index([clientId])
  @@index([status])
  @@index([dueDate])
}
